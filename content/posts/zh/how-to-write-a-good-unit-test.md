---
title: 如何编写一个好的单元测试
description: 单元测试是一种软件测试类型，专注于验证软件系统中各个独立单元的正确性……
date: 2023-11-22
tags:
  - id: "unit-test"
    title: "Unit Test"
category:
  id: program
  title: Program
---

# 什么是单元测试（What）

单元测试是一种软件测试形式，专注于验证软件系统中**单个单元**的正确性。在这里，“单元”指的是系统中**最小的**可测试部分，通常是一个方法或函数。

单元测试可以验证被测试系统的不同**行为层面**，但通常可以归为以下两类之一：**基于状态（state-based）** 或 **基于交互（interaction-based）**。

- 验证被测试系统是否产生了正确的结果，或其最终状态是否正确，这称为**基于状态的单元测试**；
- 验证被测试系统是否正确地调用了某些方法或与依赖正确交互，这称为**基于交互的单元测试**。

# 为什么要写单元测试（Why）

编写单元测试之所以重要，主要有以下几个原因：

1. **尽早发现缺陷**：单元测试可以在开发早期发现代码中的 bug 或问题。通过覆盖不同场景和边界情况，你可以在问题扩散到代码库其他部分或进入生产环境之前及时发现并解决它们。
2. **促进重构**：单元测试在代码重构时提供了一张“安全网”。你可以更有信心地修改或重构代码结构，因为只要测试通过，就能确认核心功能未被破坏。没有单元测试，重构往往会变得困难且容易出错。
3. **提升代码质量**：编写单元测试会促使你编写更加模块化、解耦且易测试的代码。它推动良好的软件工程实践，例如单一职责原则、关注点分离以及依赖注入，从而使代码更加清晰、可维护。
4. **增强团队协作**：单元测试本身也是对代码预期行为的一种文档。它们能够帮助团队成员理解代码应该如何使用、其设计意图是什么，也使新成员更容易参与到代码贡献中来。
5. **支持持续集成与持续交付（CI/CD）**：单元测试是自动化 CI/CD 流水线中的关键组成部分。它们为代码变更提供自动化校验机制，确保新功能或修复不会引入回归问题。
6. **增强信心并减少调试时间**：一套完善且稳定通过的单元测试可以极大提升对代码库稳定性的信心。当测试失败时，它通常能明确指出问题所在的位置，从而显著减少调试所需的时间和精力。

通过投入时间编写单元测试，你可以全面提升代码的质量、可维护性和可靠性。它们为更稳健、更有信心的软件开发流程奠定了基础。

# 如何编写单元测试（How）

1. **使用描述性强的测试名称**  
   _不要害怕使用较长且清晰的测试名称_。测试名称应准确描述测试的行为和预期结果，便于理解测试目的，并在失败时快速定位问题。推荐命名格式： `[Component/Feature]_[Scenario]_[ExpectedResult]`

2. **一次只测试一件事**  
   每个单元测试都应该只关注被测试单元（如一个函数或方法）的**一个具体行为**。避免在一个测试中验证多个行为，否则当测试失败时，很难判断问题的真正原因。

3. **保持测试之间相互独立、相互隔离**  
   单元测试之间不应存在依赖关系，一个测试的执行结果不应影响另一个测试。这有助于隔离问题，并更容易定位失败原因。

4. **优先覆盖 Happy Path，并测试边界情况**  
   选择能够覆盖关键用户行为、边界情况以及重要用户流程的测试用例。优先关注容易出错或对用户体验影响较大的部分。  
   Happy Path 通常是最简单、也最容易编写的测试，同时它还能**直观展示被测试代码的使用方式**。

5. **遵循 Arrange-Act-Assert（AAA）模式**  
   使用 AAA 模式来组织测试代码：

- **Arrange**：准备测试所需的前置条件和数据
- **Act**：执行被测试的操作
- **Assert**：断言预期结果是否符合预期

6. **在修复 Bug 之前先写测试**  
   一旦你发现代码行为不符合预期，优先编写一个可以复现该 bug 的测试。  
   在脱离整个应用上下文的情况下，通过调试这个测试来修复问题通常会快得多。同时，这个测试也会成为一个非常有价值的回归测试。  
   当原本失败的测试开始通过时，你就能确信这个问题已经被正确修复。

# 思考与问题（Questions）

- 如何平衡编写单元测试的时间与软件交付速度？
- **设定现实的期望**：对交付周期以及编写单元测试所需的时间设定合理预期。在项目规划时，应将测试编写的工作量纳入整体评估。
- **优先测试关键功能**：优先为关键功能或高风险区域编写单元测试，重点关注逻辑复杂、容易出错或对整体系统影响较大的部分。这样可以在有限时间内最大化测试收益。
- **重构并维护测试代码**：定期审视和重构单元测试，确保它们始终保持可维护性。删除冗余或不再必要的测试，在需求变化时及时更新测试，并确保测试与当前系统行为保持一致。
- **持续改进**：持续评估并改进你的测试流程。收集团队反馈，分析测试的有效性，找出可以优化的地方。通过这种迭代方式，不断优化测试策略，提高测试投入产出比。
- 还有其他值得思考的问题吗？
